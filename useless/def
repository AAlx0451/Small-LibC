#!/bin/bash

if ! command -v gcc &> /dev/null; then
    echo "def: error: gcc not found."
    exit 1
fi

macros=()
headers=()
parse_headers=false

for arg in "$@"; do
    if [[ "$arg" == "--" ]]; then
        parse_headers=true
        continue
    fi
    if $parse_headers; then
        headers+=("$arg")
    else
        macros+=("$arg")
    fi
done

if [[ ${#headers[@]} -eq 0 || ${#macros[@]} -eq 0 ]]; then
    echo "def: usage: $0 MACRO1 MACRO2 ... -- header.h"
    exit 1
fi

source_code=""
for h in "${headers[@]}"; do
    if [[ -f "$h" ]]; then
        source_code+="#include \"$h\""$'\n'
    else
        source_code+="#include <$h>"$'\n'
    fi
done

all_defines=$(echo "$source_code" | gcc -E -dM - 2>/dev/null)

for m in "${macros[@]}"; do
    match=$(echo "$all_defines" | grep -E "^#define $m( |\(|$)")
    if [[ -n "$match" ]]; then
        echo "$match"
    else
        echo "$m - undefined"
    fi
done
