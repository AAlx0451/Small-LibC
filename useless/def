#!/bin/bash

if ! command -v gcc &> /dev/null; then
    echo "Ошибка: gcc не найден."
    exit 1
fi

macros=()
headers=()
parse_headers=false

# 1. Парсинг аргументов
for arg in "$@"; do
    if [[ "$arg" == "--" ]]; then
        parse_headers=true
        continue
    fi
    if $parse_headers; then
        headers+=("$arg")
    else
        macros+=("$arg")
    fi
done

if [[ ${#headers[@]} -eq 0 || ${#macros[@]} -eq 0 ]]; then
    echo "Использование: $0 MACRO1 MACRO2 ... -- header.h"
    exit 1
fi

# 2. Формирование тела для препроцессора
source_code=""
for h in "${headers[@]}"; do
    if [[ -f "$h" ]]; then
        source_code+="#include \"$h\""$'\n'
    else
        source_code+="#include <$h>"$'\n'
    fi
done

# 3. Получаем ВСЕ дефайны через -dM
# gcc -E -dM -  <- выводит список всех #define, которые видны после инклюдов
all_defines=$(echo "$source_code" | gcc -E -dM - 2>/dev/null)

# 4. Фильтруем нужные
for m in "${macros[@]}"; do
    # Ищем строку, которая начинается с "#define ИМЯ " или "#define ИМЯ("
    # grep -E нужен для регулярки.
    # ^#define $m : начало строки + define + имя
    # ( |\(|$)    : после имени должен быть пробел, скобка (если функция) или конец строки (пустой дефайн)
    match=$(echo "$all_defines" | grep -E "^#define $m( |\(|$)")

    if [[ -n "$match" ]]; then
        echo "$match"
    else
        echo "$m - undefined"
    fi
done
